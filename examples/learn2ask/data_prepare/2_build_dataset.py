import json


def process_message(json_obj):
    info_set_str = ", ".join(json_obj["info_set"])
    if "user: " not in json_obj["remaining_chat"]:
        decision_str = "stop"
    else:
        decision_str = "continue"
    if info_set_str == "" and decision_str == "continue":
        if_keep = False
    else:
        if_keep = True
    return if_keep, info_set_str, decision_str


def main(input_file_path, output_file_path):
    with open(input_file_path, "r") as lines:
        data_list = [json.loads(line.strip()) for line in lines]
    print("data loaded to a list...")

    for data in data_list:
        if_keep, info_set, decision = process_message(data)
        if not if_keep:
            continue
        new_item = {
            "cid": data["cid"],
            "session_id": data["session_id"],
            "diagn": data["diagn"],
            "messages": data["messages"],
            "decision_truth": decision,
            "info_truth": info_set,
        }
        with open(output_file_path, "a") as f:
            f.write(json.dumps(new_item, ensure_ascii=False) + "\n")
    print("job done!")


if __name__ == "__main__":
    input_file_path = (
        "train_processed.jsonl"  # <<< the file generated by 1_info_extract_pipeline.py
    )
    output_file_path = "train.jsonl"  # <<< the final file for training or testing
    main(input_file_path, output_file_path)
