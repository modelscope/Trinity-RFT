name: unittest

on:
  issue_comment:
    types: [created]

permissions:
  contents: read

jobs:
  unittest:
    # only run on pull request
    if: ${{ github.event.issue.pull_request && github.event.comment.body == '/run-unittest' && github.event.comment.author_association == 'COLLABORATOR' }}
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3
      with:
        path: trinity-${{ github.run_id }}
        fetch-depth: 0

    - name: Setup docker compose
      working-directory: trinity-${{ github.run_id }}/.github/workflows/docker
      run: |
        docker compose up -d

    - name: Install Trinity-RFT
      working-directory: trinity-${{ github.run_id }}/.github/workflows/docker
      run: |
        docker compose exec trinity-node-1 pip install -e .\[dev\]
        docker compose exec trinity-node-2 pip install -e .\[dev\]

    - name: Setup Ray
      working-directory: trinity-${{ github.run_id }}/.github/workflows/docker
      run: |
        docker compose exec trinity-node-1 ray start --head --dashboard-host 0.0.0.0 --include-dashboard true
        docker compose exec trinity-node-2 ray start --address=trinity-node-1:6379

    - name: Run unittest
      working-directory: trinity-${{ github.run_id }}/.github/workflows/docker
      run: |
        docker compose exec trinity-node-1 pytest tests --ignore=tests/data
# TODO: run data tests after the dependency conflict is resolved
